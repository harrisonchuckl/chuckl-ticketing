generator client {
  provider      = "prisma-client-js"
  // Include both engine targets so the client works on Debian 11 (OpenSSL 1.1)
  // and Debian 12 (OpenSSL 3.0) runtimes.
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum OrderEmailStatus {
  SENT
  FAILED
  SKIPPED
  UNKNOWN
}

enum OrderAuditAction {
  RESEND_EMAIL
  NOTE_ADDED
  TAGS_UPDATED
  BULK_RESEND_EMAIL
  BULK_TAGS_UPDATED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum StorefrontStatus {
  DRAFT
  LIVE
}

enum StorefrontThemePage {
  ALL_EVENTS
  EVENT_PAGE
}

enum TaxMode {
  NONE
  VAT
  CUSTOM
}

enum ProductCategory {
  MERCH
  ADDON
  DIGITAL
  DONATION
  VOUCHER
}

enum ProductFulfilmentType {
  SHIPPING
  COLLECT
  EMAIL
  PRINTFUL
  NONE
}

enum PrintfulShippingPolicy {
  PASS_THROUGH
  INCLUDED
  THRESHOLD
}

enum InventoryMode {
  UNLIMITED
  TRACKED
}

enum ProductOrderSource {
  TICKET_CHECKOUT
  STOREFRONT_ONLY
}

enum ProductOrderStatus {
  PAID
  REFUNDED
  CANCELLED
}

enum ProductOrderFulfilmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
  ERROR
}

enum ProductOrderItemStatus {
  UNFULFILLED
  FULFILLED
  ERROR
}

enum FulfilmentProvider {
  PRINTFUL
  PRINTIFY
  GELATO
}

enum InventoryMovementReason {
  SALE
  ADJUSTMENT
  REFUND
}

enum SeatStatus {
  AVAILABLE
  HELD
  SOLD
  BLOCKED
}

enum ShowStatus {
  DRAFT
  LIVE
}

enum PlatformRole {
  USER
  PLATFORM_ADMIN
}

enum OrganiserType {
  VENUE
  PROMOTER
  ARTIST
  OTHER
}

enum SubscriptionStatus {
  NONE
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum VenueRole {
  OWNER
  MANAGER
  BOX_OFFICE
  FINANCE
  READ_ONLY
}

enum PromoterStatus {
  PROSPECT
  ACTIVE
  DORMANT
  BLOCKED
}

enum PromoterDocumentStatus {
  MISSING
  UPLOADED
  EXPIRED
  APPROVED
}

enum PromoterDocumentType {
  PRS_CERTIFICATE
  PPL_MUSIC_LICENSING
  PUBLIC_LIABILITY_INSURANCE
  RISK_ASSESSMENT
  TECH_SPEC
  MARKETING_SPEC
  ACCESSIBILITY_INFO
  BRANDING_GUIDELINES
  OTHER
}

enum PromoterActivityType {
  CREATED
  UPDATED
  CONTACT_ADDED
  CONTACT_UPDATED
  CONTACT_REMOVED
  DOCUMENT_UPLOADED
  DOCUMENT_UPDATED
  DOCUMENT_REMOVED
}

enum MarketingConsentStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  TRANSACTIONAL_ONLY
  BOUNCED
  COMPLAINED
}

enum MarketingLawfulBasis {
  EXPLICIT_OPT_IN
  SOFT_OPT_IN
  UNKNOWN
  CONSENT
  LEGITIMATE_INTEREST
}

enum MarketingConsentSource {
  CHECKOUT
  MANUAL_IMPORT
  ADMIN_EDIT
  API
  NEWSLETTER_SIGNUP
  IMPORT_CSV
}

enum MarketingImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MarketingSuppressionType {
  UNSUBSCRIBE
  HARD_BOUNCE
  SPAM_COMPLAINT
}

enum MarketingCampaignStatus {
  DRAFT
  APPROVAL_REQUIRED
  SCHEDULED
  SENDING
  PAUSED_LIMIT
  FAILED
  SENT
  CANCELLED
}

enum MarketingCampaignType {
  ONE_OFF
  SHOW_REMINDER
  ROUNDUP
  ANNOUNCEMENT
}

enum MarketingGovernanceRole {
  VIEWER
  CAMPAIGN_CREATOR
  APPROVER
}

enum MarketingTemplateChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MarketingAutomationTriggerType {
  AFTER_PURCHASE
  NO_PURCHASE_DAYS
  VIP_THRESHOLD
  SHOW_CATEGORY_INTEREST
  ABANDONED_CHECKOUT
  SHOW_CREATED
  SHOW_PUBLISHED
  DAYS_BEFORE_SHOW
  MONTHLY_ROUNDUP
  LOW_SALES_VELOCITY
  VIEWED_NO_PURCHASE
  BIRTHDAY
  ANNIVERSARY
  TAG_APPLIED
  PREFERENCE_TOPIC
}

enum MarketingAutomationStepType {
  SEND_EMAIL
  WAIT
  BRANCH
  ADD_TAG
  UPDATE_PREFERENCE
  NOTIFY_ORGANISER
}

enum MarketingAutomationStateStatus {
  ACTIVE
  COMPLETED
  STOPPED
}

enum MarketingAutomationStepStatus {
  SENT
  FAILED
  SKIPPED
}

enum MarketingRecipientStatus {
  PENDING
  RETRYABLE
  SENT
  FAILED
  SKIPPED_SUPPRESSED
}

enum MarketingEmailEventType {
  DELIVERED
  BOUNCE
  COMPLAINT
  OPEN
  CLICK
  UNSUBSCRIBE
}

enum MarketingPreferenceStatus {
  SUBSCRIBED
  UNSUBSCRIBED
}

enum MarketingCheckoutStatus {
  STARTED
  COMPLETED
}

enum ShowEventType {
  VIEW
  ADD_TO_CART
  CHECKOUT_START
  PAID
}

enum CrmSurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum SupportTicketCategory {
  RESEND
  SEATING
  REFUND
  PAYMENT
  VENUE
  OTHER
}

enum SupportTicketStatus {
  OPEN
  PENDING
  RESOLVED
}

enum SupportTicketPriority {
  LOW
  MED
  HIGH
}

enum SupportMessageSenderType {
  CUSTOMER
  STAFF
  SYSTEM
}

enum StoreAddOnMode {
  UPSELL
  TICKET_ADDON
  BUNDLE
}

enum StoreBundleDiscountType {
  FIXED
  PCNT
}

enum StoreFulfilmentKind {
  COLLECT
  POST
  DIGITAL
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name         String?
  email        String       @unique
  passwordHash String?
  role         String?
  platformRole PlatformRole @default(USER)

  organiserSplitBps Int?
  organiserProfile  OrganiserProfile?

  // ✅ Password reset fields
  resetTokenHash        String?   @db.Text
  resetTokenExpiresAt   DateTime?
  resetTokenRequestedAt DateTime?
  resetTokenUsedAt      DateTime?

  orders                     Order[]
  showsOrganised             Show[]                      @relation("OrganiserShows")
  tickets                    Ticket[]
  orderNotes                 OrderNote[]                 @relation("OrderNoteAuthor")
  storefronts                Storefront[]
  dashboardWidgetPreferences DashboardWidgetPreference[]
  orderAuditLogs             OrderAuditLog[]             @relation("OrderAuditActor")
  marketingAiDraftsOrganised MarketingAiDraft[] @relation("MarketingAiDraftOrganiser")
  marketingAiDraftsCreated   MarketingAiDraft[] @relation("MarketingAiDraftCreatedBy")
  adminAuditLogs             AdminAuditLog[]             @relation("AdminAuditActor")


  venueMemberships    VenueMember[]
  invitedVenueMembers VenueMember[] @relation("VenueInviter")
  venueInvitesCreated VenueInvite[] @relation("VenueInviteCreatedBy")
  venuesOwned         Venue[]       @relation("VenueOwner")

  promotersOwned            Promoter[]         @relation("PromoterOwner")
  promoterMemberships       PromoterMember[]
  promoterDocumentsUploaded PromoterDocument[] @relation("PromoterDocumentUploader")
  promoterActivities        PromoterActivity[] @relation("PromoterActivityAuthor")

  // Slug history for organiser show URLs
  showSlugHistory ShowSlugHistory[]

  // --- organiser business details (optional) ---
  companyName   String?
  tradingName   String?
  companyNumber String?
  vatNumber     String?
  phone         String?
  brandLogoUrl  String?
  brandColorRgb String?
  brandColorHex String?
  addressLine1  String?
  addressLine2  String?
  city          String?
  county        String?
  postcode      String?
  country       String?

  // --- storefront (must be unique per organiser) ---
  storefrontSlug String? @unique

  marketingContacts          MarketingContact[]
  marketingTags              MarketingTag[]
  marketingTemplates         MarketingTemplate[]
  marketingTemplatesLocked   MarketingTemplate[]        @relation("MarketingTemplateLockedBy")
  marketingTemplateVersions  MarketingTemplateVersion[] @relation("MarketingTemplateVersionAuthor")
  marketingTemplateChangesRequested MarketingTemplateChangeRequest[] @relation("MarketingTemplateChangeRequestedBy")
  marketingTemplateChangesApproved  MarketingTemplateChangeRequest[] @relation("MarketingTemplateChangeApprovedBy")
  marketingEmailTemplates    MarketingEmailTemplate[]
  marketingSegments          MarketingSegment[]
  marketingCampaigns         MarketingCampaign[]        @relation("MarketingCampaignCreatedBy")
  marketingCampaignsAsTenant MarketingCampaign[]        @relation("MarketingCampaignTenant")
  marketingCampaignsScheduled MarketingCampaign[]       @relation("MarketingCampaignScheduledBy")
  marketingCampaignsApproved  MarketingCampaign[]       @relation("MarketingCampaignApprovedBy")
  marketingRoleAssignments   MarketingRoleAssignment[]  @relation("MarketingRoleAssignee")
  marketingRoleTenants       MarketingRoleAssignment[]  @relation("MarketingRoleTenant")
  marketingSuppressions      MarketingSuppression[]
  marketingAutomations       MarketingAutomation[]
  marketingSettings          MarketingSettings?
  marketingPreferenceTopics  MarketingPreferenceTopic[]
  marketingCheckoutEvents    MarketingCheckoutEvent[]
  marketingAuditLogs         MarketingAuditLog[]
  marketingAuditLogsAsActor  MarketingAuditLog[]        @relation("MarketingAuditActor")
  marketingImportJobs        MarketingImportJob[]
  marketingDailySendCounters MarketingDailySendCounter[]
  campaignDrafts             CampaignDraft[]
  upsellBundles              UpsellBundle[]

  crmSegments                 CrmSegment[]
  crmSegmentMembers           CrmSegmentMember[]
  crmTags                     CrmTag[] @relation("CrmTagOrganiser")
  crmCustomerTagsOrganiser    CrmCustomerTag[] @relation("CrmCustomerTagOrganiser")
  crmCustomerTagsCustomer     CrmCustomerTag[] @relation("CrmCustomerTagCustomer")
  crmEventViewsOrganiser      CrmEventView[] @relation("CrmEventViewOrganiser")
  crmEventViewsCustomer       CrmEventView[] @relation("CrmEventViewCustomer")
  crmSurveys                  CrmSurvey[]
  crmSurveyResponses          CrmSurveyResponse[]
  storeTaxRates               StoreTaxRate[]
  storeFulfilmentMethods      StoreFulfilmentMethod[]
  storeShowAddOns             StoreShowAddOn[]
  storeBundleRules            StoreBundleRule[]
  supportTicketsOrganised     SupportTicket[] @relation("SupportTicketOrganiser")
  supportTicketsCustomer      SupportTicket[] @relation("SupportTicketCustomer")
  chatbotKnowledgeSources     ChatbotKnowledgeSource[] @relation("ChatbotKnowledgeOrganiser")
  chatbotTranscriptsOrganiser ChatbotTranscript[] @relation("ChatbotTranscriptOrganiser")
  chatbotTranscriptsCustomer  ChatbotTranscript[] @relation("ChatbotTranscriptCustomer")
  chatbotEscalationRules      ChatbotEscalationRule[] @relation("ChatbotEscalationOrganiser")
  fulfilmentIntegrations      FulfilmentIntegration[]
  fulfilmentProductMappings   FulfilmentProductMapping[]
  printfulPricingConfig       PrintfulPricingConfig?
  productOrderProfitSnapshots ProductOrderProfitSnapshot[]
  productOrderItemProfitSnapshots ProductOrderItemProfitSnapshot[]

  featuredConfigs            FeaturedConfig[]
  featuredPins               FeaturedPin[]
  featuredRegionRules        FeaturedRegionRule[]
  featuredDecisionLogs       FeaturedDecisionLog[]
  marketingAiTemplates       MarketingAiTemplate[]
  marketingAiTonePresets     MarketingAiTonePreset[]
  marketingAiSuggestions     MarketingAiSuggestion[]
  storefrontThemes          StorefrontTheme[]

  customerInsights CustomerInsight[]
}

model MarketingSettings {
  tenantId               String   @id
  defaultFromName        String?
  defaultFromEmail       String?
  defaultReplyTo         String?
  requireVerifiedFrom    Boolean
  sendingMode            MarketingSenderMode @default(SENDGRID)
  verifiedStatus         MarketingVerifiedStatus @default(UNVERIFIED)
  sendgridDomainId       String?
  sendgridDomain         String?
  sendgridSubdomain      String?
  sendgridDnsRecords     Json?
  smtpHost               String?
  smtpPort               Int?
  smtpUserEncrypted      String?
  smtpPassEncrypted      String?
  smtpSecure             Boolean?
  smtpLastTestAt         DateTime?
  dailyLimitOverride     Int?
  sendRatePerSecOverride Int?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  tenant User @relation(fields: [tenantId], references: [id])
}

enum MarketingSenderMode {
  SENDGRID
  SMTP
}

enum MarketingVerifiedStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  FAILED
}

model OrganiserProfile {
  userId                 String             @id
  organiserType          OrganiserType      @default(OTHER)
  subscriptionStatus     SubscriptionStatus @default(NONE)
  subscriptionPlan       String?
  subscriptionPeriodEnd  DateTime?
  permissionsJson        Json?
  notes                  String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CustomerAccount {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  email            String   @unique
  passwordHash     String
  name             String?
  phone            String?
  marketingConsent Boolean  @default(false)
  lastLoginAt      DateTime?
  emailVerifiedAt  DateTime?
  emailVerificationTokenHash String? @db.Text
  emailVerificationExpiresAt DateTime?

  memberships CustomerStorefrontMembership[]
  baskets     Basket[]
  orders      Order[]
  rememberTokens CustomerRememberToken[]
  showViews     CustomerShowView[]
  customerInsights CustomerInsight[]
}

model CustomerStorefrontMembership {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  customerAccountId String
  storefrontId      String
  marketingOptIn    Boolean  @default(false)
  preferencesJson   Json?

  customerAccount CustomerAccount @relation(fields: [customerAccountId], references: [id])
  storefront      Storefront      @relation(fields: [storefrontId], references: [id])

  @@unique([customerAccountId, storefrontId])
  @@index([storefrontId])
}

model CustomerRememberToken {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  customerAccountId String
  tokenHash         String   @unique @db.Text
  expiresAt         DateTime
  lastUsedAt        DateTime?
  userAgent         String?
  ipAddress         String?

  customerAccount CustomerAccount @relation(fields: [customerAccountId], references: [id])

  @@index([customerAccountId])
  @@index([expiresAt])
}

model CustomerShowView {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  showId            String
  customerAccountId String?
  sessionId         String?
  source            String?

  show            Show             @relation(fields: [showId], references: [id])
  customerAccount CustomerAccount? @relation(fields: [customerAccountId], references: [id])

  @@index([showId])
  @@index([customerAccountId])
  @@index([createdAt])
}

model CustomerInsight {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId          String
  email             String
  customerAccountId String?
  customerKey       String   @unique

  firstPurchaseAt        DateTime?
  lastPurchaseAt         DateTime?
  purchaseCount          Int      @default(0)
  purchaseCount90d       Int      @default(0)
  ticketsBoughtLifetime  Int      @default(0)
  avgTicketsPerOrder     Float    @default(0)
  groupBuyerScore        Boolean  @default(false)
  monetaryValueLifetimePence Int  @default(0)
  monetaryValue90dPence      Int  @default(0)

  recencyScore   Int    @default(0)
  frequencyScore Int    @default(0)
  monetaryScore  Int    @default(0)
  rfmSegment     String?

  favouriteVenueId  String?
  topVenueIds       String[] @default([])
  favouriteCategory String?
  favouriteEventType String?

  tenant          User            @relation(fields: [tenantId], references: [id])
  customerAccount CustomerAccount? @relation(fields: [customerAccountId], references: [id])

  @@index([tenantId])
  @@index([email])
  @@index([customerAccountId])
  @@index([tenantId, email])
  @@index([tenantId, customerAccountId])
}

model CustomerInsightsWorkerState {
  id                 String   @id
  lastRunAt          DateTime?
  lastRunCompletedAt DateTime?
  lastProcessedCount Int      @default(0)
  lastError          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Basket {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  storefrontId      String
  customerAccountId String?
  guestSessionId    String?

  storefront      Storefront       @relation(fields: [storefrontId], references: [id])
  customerAccount CustomerAccount? @relation(fields: [customerAccountId], references: [id])
  items           BasketItem[]

  @@unique([customerAccountId, storefrontId])
  @@index([storefrontId])
}

model BasketItem {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  basketId          String
  productId         String
  variantId         String?
  qty               Int
  customAmountPence Int?

  basket  Basket         @relation(fields: [basketId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([basketId])
}

model DashboardWidgetPreference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  widgetKey String
  enabled   Boolean  @default(true)
  order     Int?

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, widgetKey])
  @@index([userId])
}

model AccessRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String?
  email       String  @unique
  companyName String?

  tokenHash  String    @unique @db.Text
  approvedAt DateTime?
  approvedBy String?
}

model Venue {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  address  String?
  city     String?
  county   String?
  postcode String?
  capacity Int?

  imageUrl        String?
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  ticketContraBps Int?
  bookingFeeBps   Int?
  spaces          String[] @default([])
  seatingMaps     String[] @default([])

  shows    Show[]
  seatMaps SeatMap[]

  ownerId String?
  owner   User?   @relation("VenueOwner", fields: [ownerId], references: [id])

  members      VenueMember[]
  venueInvites VenueInvite[] @relation("VenueInviteVenue")

  @@index([ownerId])
}

model Promoter {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  tradingName String?
  email       String?
  phone       String?
  logoUrl     String?
  website     String?
  websiteDomain String? @unique

  companyNumber String?
  vatNumber     String?

  addressLine1 String?
  addressLine2 String?
  city         String?
  county       String?
  postcode     String?
  country      String?

  status PromoterStatus @default(PROSPECT)
  notes  String?

  ownerId String?
  owner   User?   @relation("PromoterOwner", fields: [ownerId], references: [id])

  contacts   PromoterContact[]
  documents  PromoterDocument[]
  activities PromoterActivity[]
  showLinks  ShowPromoter[]
  members    PromoterMember[]
  products   Product[]
}

model PromoterMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  promoterId String
  userId     String

  promoter Promoter @relation(fields: [promoterId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([promoterId, userId])
  @@index([promoterId])
  @@index([userId])
}

model PromoterContact {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  promoterId String
  promoter   Promoter @relation(fields: [promoterId], references: [id])

  name  String
  role  String?
  email String?
  phone String?
  tags  String[] @default([])

  isPrimaryFinance   Boolean @default(false)
  isPrimaryMarketing Boolean @default(false)

  @@index([promoterId])
}

model PromoterDocument {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  promoterId String
  promoter   Promoter @relation(fields: [promoterId], references: [id])

  venueId String?

  type      PromoterDocumentType
  title     String
  fileUrl   String
  fileName  String?
  mime      String?
  size      Int?
  expiresAt DateTime?
  status    PromoterDocumentStatus @default(UPLOADED)

  uploadedByUserId String?
  uploadedBy       User?   @relation("PromoterDocumentUploader", fields: [uploadedByUserId], references: [id])

  @@index([promoterId])
}

model PromoterActivity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  promoterId String
  promoter   Promoter @relation(fields: [promoterId], references: [id])

  type     PromoterActivityType
  metadata Json?

  createdByUserId String?
  createdBy       User?   @relation("PromoterActivityAuthor", fields: [createdByUserId], references: [id])

  @@index([promoterId])
}

model VenueInvite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venueId     String
  email       String
  role        VenueRole @default(READ_ONLY)
  permissions String[]  @default([])

  tokenHash String   @db.Text
  expiresAt DateTime

  createdById String?
  createdBy   User?   @relation("VenueInviteCreatedBy", fields: [createdById], references: [id])

  revokedAt  DateTime?
  acceptedAt DateTime?

  venue Venue @relation("VenueInviteVenue", fields: [venueId], references: [id])

  @@unique([tokenHash])
  @@index([venueId])
  @@index([email])
}

model VenueMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venueId String
  userId  String

  role VenueRole @default(READ_ONLY)

  // Tick-box system for MVP, expandable later:
  // e.g. ["FINANCE_VIEW", "FINANCE_EDIT_PAYOUTS", "EVENT_CREATE", ...]
  permissions String[] @default([])

  invitedByUserId String?
  invitedAt       DateTime?
  acceptedAt      DateTime?

  venue Venue @relation(fields: [venueId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  invitedBy User? @relation("VenueInviter", fields: [invitedByUserId], references: [id])

  @@unique([venueId, userId])
  @@index([venueId])
  @@index([userId])
}

model Show {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String?
  description String?
  imageUrl    String?
  date        DateTime
  endDate     DateTime?

  doorsOpenTime String?
  ageGuidance   String?
  endTimeNote   String?

  eventType        String?
  eventCategory    String?
  additionalImages String[] @default([])
  tags             String[] @default([])
  accessibility    Json?

  externalTicketUrl   String?
  usesExternalTicketing Boolean @default(false)

  status      ShowStatus @default(DRAFT)
  publishedAt DateTime?
  // --- pretty URL slug (generated on publish / title change) ---
  slug        String?

  usesAllocatedSeating Boolean?
  activeSeatMapId      String?

  /// Overall show capacity across all ticket types.
  /// If set, checkout will never allow more than this total quantity sold/reserved.
  /// If null, capacity is derived from ticket allocations (unlimited if any allocation is blank).
  showCapacity Int?

  venueId     String?
  organiserId String?

  venue     Venue? @relation(fields: [venueId], references: [id])
  organiser User?  @relation("OrganiserShows", fields: [organiserId], references: [id])

  ticketTypes TicketType[]
  tickets     Ticket[]
  orders      Order[]
  seatMaps    SeatMap[]
  allocations ExternalAllocation[]

  // Slug history for public URL redirects
  slugHistory   ShowSlugHistory[]
  promoterLinks ShowPromoter[]
  upsellRules   UpsellRule[]
  campaignDrafts CampaignDraft[]
  upsellBundles  UpsellBundle[]
  showEvents     ShowEvent[]
  marketingAiDrafts MarketingAiDraft[]
  featuredPins      FeaturedPin[]
  crmEventViews      CrmEventView[]
  crmSurveys         CrmSurvey[]
  storeShowAddOns    StoreShowAddOn[]
  storeBundleRules   StoreBundleRule[]
  supportTickets     SupportTicket[]
  chatbotTranscripts ChatbotTranscript[]
  customerShowViews  CustomerShowView[]
  marketingCampaigns MarketingCampaign[]

  @@index([venueId])
  @@index([organiserId])
  @@index([date])
}

model ShowEvent {
  id        String        @id @default(cuid())
  showId    String
  type      ShowEventType
  ts        DateTime      @default(now())
  sessionId String?
  orderId   String?

  show Show @relation(fields: [showId], references: [id])

  @@index([showId, ts])
  @@index([type, ts])
}

model FeaturedConfig {
  id          String   @id @default(cuid())
  organiserId String
  mode        String
  slotCount   Int
  weights     Json
  exclusions  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organiser User @relation(fields: [organiserId], references: [id])

  @@unique([organiserId])
}

model FeaturedPin {
  id           String   @id @default(cuid())
  organiserId  String
  showId       String
  priority     Int
  regionCounty String?
  createdAt    DateTime @default(now())

  organiser User @relation(fields: [organiserId], references: [id])
  show      Show @relation(fields: [showId], references: [id])

  @@index([organiserId])
  @@index([showId])
}

model FeaturedRegionRule {
  id                 String   @id @default(cuid())
  organiserId        String
  county             String
  weightsOverride    Json?
  exclusionsOverride Json?
  createdAt          DateTime @default(now())

  organiser User @relation(fields: [organiserId], references: [id])

  @@unique([organiserId, county])
  @@index([organiserId])
}

model FeaturedDecisionLog {
  id          String   @id @default(cuid())
  organiserId String
  county      String?
  computedAt  DateTime @default(now())
  results     Json

  organiser User @relation(fields: [organiserId], references: [id])

  @@index([organiserId, computedAt])
}

model MarketingAiDraft {
  id              String   @id @default(cuid())
  organiserId     String
  showId          String?
  channel         String
  objective       String
  tone            String
  title           String
  content         String   @db.Text
  sourceTemplateId String?
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organiser  User  @relation("MarketingAiDraftOrganiser", fields: [organiserId], references: [id])
  show      Show? @relation(fields: [showId], references: [id])
  sourceTemplate MarketingAiTemplate? @relation(fields: [sourceTemplateId], references: [id])
  createdBy  User? @relation("MarketingAiDraftCreatedBy", fields: [createdByUserId], references: [id])
  performance MarketingAiDraftPerformance?

  @@index([organiserId])
  @@index([showId])
}

model MarketingAiTemplate {
  id          String   @id @default(cuid())
  organiserId String
  channel     String
  objective   String
  tone        String
  title       String
  body        String   @db.Text
  conditions  Json?
  approved    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organiser User @relation(fields: [organiserId], references: [id])
  drafts    MarketingAiDraft[]

  @@index([organiserId])
}

model MarketingAiTonePreset {
  id          String   @id @default(cuid())
  organiserId String
  name        String
  rules       Json?
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organiser User @relation(fields: [organiserId], references: [id])

  @@index([organiserId])
}

model MarketingAiDraftPerformance {
  id       String   @id @default(cuid())
  draftId  String   @unique
  used     Boolean  @default(false)
  usedAt   DateTime?
  platform String?
  metrics  Json?
  notes    String?
  updatedAt DateTime @updatedAt

  draft MarketingAiDraft @relation(fields: [draftId], references: [id])
}

model MarketingAiSuggestion {
  id               String   @id @default(cuid())
  organiserId      String
  showId           String?
  suggestionType   String
  suggestionPayload Json
  sourceData       Json?
  used             Boolean  @default(false)
  usedAt           DateTime?
  feedback         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organiser User  @relation(fields: [organiserId], references: [id])
  show      Show? @relation(fields: [showId], references: [id])

  @@index([organiserId])
  @@index([showId])
}

model CampaignDraft {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  showId String

  objective      String
  riskLevel      String?
  timeToShowDays Int?
  audienceRules  Json?
  schedule       Json?
  copySkeleton   String?
  notes          String?

  createdByUserId String?

  show      Show  @relation(fields: [showId], references: [id])
  createdBy User? @relation(fields: [createdByUserId], references: [id])

  @@index([showId])
  @@index([createdByUserId])
}

model UpsellBundle {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  showId String

  template          String?
  title             String?
  recommendedReason String?
  items             Json?
  status            String?

  createdByUserId String?

  show      Show  @relation(fields: [showId], references: [id])
  createdBy User? @relation(fields: [createdByUserId], references: [id])

  @@index([showId])
  @@index([createdByUserId])
}

model ShowPromoter {
  id                  String   @id @default(cuid())
  createdAt           DateTime @default(now())
  showId              String
  promoterId          String
  weeklyReportEnabled Boolean  @default(false)
  weeklyReportEmail   String?
  weeklyReportTime    String?

  show     Show     @relation(fields: [showId], references: [id])
  promoter Promoter @relation(fields: [promoterId], references: [id])

  @@unique([showId, promoterId])
  @@index([showId])
  @@index([promoterId])
}

model ShowSlugHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  organiserId String
  showId      String
  slug        String

  organiser User @relation(fields: [organiserId], references: [id])
  show      Show @relation(fields: [showId], references: [id])

  @@unique([organiserId, slug])
  @@index([showId])
}

model TicketType {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name       String
  pricePence Int

  /// Booking fee charged on top of face value (per ticket, in pence).
  /// Must be >= tier minimum for this ticket price (enforced server-side).
  bookingFeePence Int?

  /// When this ticket should first be available to buy
  onSaleAt  DateTime?
  /// When this ticket should stop being available
  offSaleAt DateTime?

  /// Numeric availability used by routes (e.g. comparisons like > 0)
  available Int?

  showId String
  show   Show   @relation(fields: [showId], references: [id])

  tickets Ticket[]
  orders  Order[]

  upsellRules UpsellRule[]
}

model Order {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  amountPence         Int
  platformFeePence    Int?
  organiserSharePence Int?
  paymentFeePence     Int?
  netPayoutPence      Int?

  stripeId       String?
  status         OrderStatus @default(PENDING)
  email          String?
  // ✅ Captured from Stripe Checkout custom_fields
  buyerFirstName String?
  buyerLastName  String?
  buyerPostcode  String?

  storefrontId         String?
  shippingName         String?
  shippingEmail        String?
  shippingPhone        String?
  shippingAddressJson  Json?
  containsProducts     Boolean @default(false)
  containsTickets      Boolean @default(true)
  productSubtotalPence Int     @default(0)
  ticketSubtotalPence  Int     @default(0)

  /// Some routes read a top-level quantity directly on the order
  quantity Int?

  tags                String[]          @default([])
  emailDeliveryStatus OrderEmailStatus?
  emailDeliveryAt     DateTime?
  emailDeliveryError  String?
  emailPdfAttached    Boolean?

  showId       String
  userId       String?
  customerAccountId String?
  ticketTypeId String?

  show       Show        @relation(fields: [showId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])
  customerAccount CustomerAccount? @relation(fields: [customerAccountId], references: [id])
  ticketType TicketType? @relation(fields: [ticketTypeId], references: [id])
  storefront Storefront? @relation(fields: [storefrontId], references: [id])

  tickets   Ticket[]
  refunds   Refund[]
  notes     OrderNote[]
  auditLogs OrderAuditLog[]
  supportTickets SupportTicket[]

  seatsCsv                String?        @db.Text
  stripeCheckoutSessionId String?        @db.VarChar(255)
  productOrders           ProductOrder[]

  @@index([createdAt])
  @@index([status])
  @@index([showId])
  @@index([ticketTypeId])
  @@index([email])
  @@index([stripeId])
  @@index([stripeCheckoutSessionId])
  @@index([emailDeliveryStatus])
  @@index([storefrontId])
  @@index([customerAccountId])
}

model Storefront {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerUserId  String
  name         String
  slug         String           @unique
  status       StorefrontStatus @default(DRAFT)
  logoUrl      String?
  brandColour  String?
  supportEmail String?
  policiesText String?

  taxMode    TaxMode @default(NONE)
  taxPercent Int?

  shippingEnabled      Boolean @default(false)
  collectionEnabled    Boolean @default(false)
  digitalEnabled       Boolean @default(false)
  shippingFlatFeePence Int?

  owner         User           @relation(fields: [ownerUserId], references: [id])
  products      Product[]
  orders        Order[]
  memberships   CustomerStorefrontMembership[]
  baskets       Basket[]
  upsellRules   UpsellRule[]
  productOrders ProductOrder[]

  @@index([ownerUserId])
}

model StorefrontTheme {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  organiserId String
  page        StorefrontThemePage
  draftJson   Json?
  publishedJson Json?
  publishedAt DateTime?

  organiser User @relation(fields: [organiserId], references: [id])

  @@unique([organiserId, page])
  @@index([organiserId])
}

model FulfilmentIntegration {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organiserId          String
  provider             FulfilmentProvider
  accessTokenEncrypted String?  @db.Text
  refreshTokenEncrypted String? @db.Text
  accessTokenExpiresAt DateTime?

  organiser User @relation(fields: [organiserId], references: [id])

  @@unique([organiserId, provider])
  @@index([organiserId])
}

model FulfilmentProductMapping {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organiserId      String
  provider         FulfilmentProvider
  productId        String
  productVariantId String?
  providerProductId String
  providerVariantId String?
  providerBasePricePence Int?
  providerBaseCurrency   String? @default("gbp")
  providerBaseUpdatedAt  DateTime?
  providerShippingEstimatePence Int?
  providerTaxEstimatePence Int?

  organiser      User           @relation(fields: [organiserId], references: [id])
  product        Product        @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([organiserId])
  @@index([productId])
  @@index([productVariantId])
  @@index([provider, providerProductId])
  @@unique([provider, productId, productVariantId])
}

model Product {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storefrontId      String
  title             String
  slug              String
  status            ProductStatus         @default(DRAFT)
  category          ProductCategory       @default(MERCH)
  description       String?
  fulfilmentType    ProductFulfilmentType @default(NONE)
  pricePence        Int?
  retailPricePence  Int?
  compareAtPricePence Int?
  marginRuleUsed    String?
  currency          String                @default("gbp")
  allowCustomAmount Boolean               @default(false)
  inventoryMode     InventoryMode         @default(UNLIMITED)
  stockCount        Int?
  lowStockThreshold Int?
  preorderEnabled   Boolean               @default(false)
  preorderCloseAt   DateTime?
  maxPerOrder       Int?
  maxPerTicket      Int?
  promoterId        String?

  storefront         Storefront          @relation(fields: [storefrontId], references: [id])
  promoter           Promoter?           @relation(fields: [promoterId], references: [id])
  basketItems        BasketItem[]
  variants           ProductVariant[]
  images             ProductImage[]
  upsellRules        UpsellRule[]
  orderItems         ProductOrderItem[]
  inventoryMovements InventoryMovement[]
  storeShowAddOns    StoreShowAddOn[]
  fulfilmentMappings FulfilmentProductMapping[]

  @@unique([storefrontId, slug])
  @@index([storefrontId, status])
  @@index([storefrontId, promoterId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId          String
  title              String
  sku                String?
  pricePenceOverride Int?
  stockCountOverride Int?
  sortOrder          Int     @default(0)

  product            Product             @relation(fields: [productId], references: [id])
  basketItems        BasketItem[]
  orderItems         ProductOrderItem[]
  inventoryMovements InventoryMovement[]
  upsellRules        UpsellRule[]
  fulfilmentMappings FulfilmentProductMapping[]

  @@index([productId])
}

model ProductImage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId String
  url       String
  sortOrder Int    @default(0)

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model UpsellRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storefrontId         String
  productId            String
  productVariantId     String?
  showId               String?
  ticketTypeId         String?
  priority             Int     @default(1)
  recommended          Boolean @default(true)
  active               Boolean @default(true)
  maxPerOrderOverride  Int?
  maxPerTicketOverride Int?

  storefront     Storefront      @relation(fields: [storefrontId], references: [id])
  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  show           Show?           @relation(fields: [showId], references: [id])
  ticketType     TicketType?     @relation(fields: [ticketTypeId], references: [id])

  @@index([storefrontId])
  @@index([showId, active, priority])
}

model ProductOrder {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storefrontId            String
  orderId                 String?
  source                  ProductOrderSource
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?

  customerName        String?
  customerEmail       String?
  customerPhone       String?
  shippingAddressJson Json?

  subtotalPence Int
  taxPence      Int
  shippingPence Int
  totalPence    Int
  currency      String

  status           ProductOrderStatus
  fulfilmentStatus ProductOrderFulfilmentStatus @default(UNFULFILLED)

  printfulOrderId        String?
  printfulCostSubtotalPence Int?
  printfulShippingPence  Int?
  printfulTaxPence       Int?
  printfulTotalPence     Int?
  printfulCostCurrency   String?
  printfulCostRawJson    Json?

  storefront Storefront         @relation(fields: [storefrontId], references: [id])
  order      Order?             @relation(fields: [orderId], references: [id])
  items      ProductOrderItem[]
  profitSnapshot ProductOrderProfitSnapshot?

  @@index([storefrontId])
  @@index([stripeCheckoutSessionId])
}

model ProductOrderItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productOrderId         String
  productId              String
  variantId              String?
  titleSnapshot          String
  variantSnapshot        String?
  unitPricePence         Int
  qty                    Int
  lineTotalPence         Int
  fulfilmentTypeSnapshot ProductFulfilmentType
  fulfilmentStatus       ProductOrderItemStatus @default(UNFULFILLED)
  fulfilmentProviderOrderId String?
  fulfilmentErrorMessage String?
  trackingNumber         String?
  trackingUrl            String?
  trackingCarrier        String?
  metadataJson           Json?

  productOrder ProductOrder    @relation(fields: [productOrderId], references: [id])
  product      Product         @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])
  profitSnapshot ProductOrderItemProfitSnapshot?

  @@index([productOrderId])
}


model PrintfulPricingConfig {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organiserId String @unique
  marginBps   Int    @default(1500)
  vatRegistered Boolean @default(true)
  vatRateBps Int @default(2000)
  shippingPolicy PrintfulShippingPolicy @default(PASS_THROUGH)
  stripeFeeBps Int @default(150)
  stripeFeeFixedPence Int @default(20)
  allowNegativeMargin Boolean @default(false)
  minimumProfitPence Int @default(0)

  organiser User @relation(fields: [organiserId], references: [id])

  @@index([organiserId])
}

model ProductOrderProfitSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productOrderId String @unique
  organiserId String

  retailSubtotalPence Int
  retailShippingPence Int
  retailTaxPence Int
  retailTotalPence Int

  printfulSubtotalPence Int
  printfulShippingPence Int
  printfulTaxPence Int
  printfulTotalPence Int

  stripeFeePence Int
  vatEstimatePence Int
  netProfitPence Int
  currency String

  marginBpsUsed Int
  vatRateBpsUsed Int
  shippingPolicyUsed PrintfulShippingPolicy
  negativeMargin Boolean @default(false)
  missingPrintfulCost Boolean @default(false)

  organiserSharePence Int @default(0)
  platformSharePence Int @default(0)
  creatorSharePence Int @default(0)

  organiser User @relation(fields: [organiserId], references: [id])
  productOrder ProductOrder @relation(fields: [productOrderId], references: [id])
  itemSnapshots ProductOrderItemProfitSnapshot[]

  @@index([organiserId])
}

model ProductOrderItemProfitSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productOrderItemId String @unique
  profitSnapshotId String
  organiserId String

  retailUnitPricePence Int
  retailLineTotalPence Int
  printfulUnitCostPence Int
  printfulLineTotalPence Int
  stripeFeePence Int
  vatEstimatePence Int
  netProfitPence Int
  currency String
  marginBpsUsed Int
  negativeMargin Boolean @default(false)

  organiserSharePence Int @default(0)
  platformSharePence Int @default(0)
  creatorSharePence Int @default(0)

  organiser User @relation(fields: [organiserId], references: [id])
  profitSnapshot ProductOrderProfitSnapshot @relation(fields: [profitSnapshotId], references: [id])
  productOrderItem ProductOrderItem @relation(fields: [productOrderItemId], references: [id])

  @@index([organiserId])
}

model InventoryMovement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  productId String
  variantId String?
  change    Int
  reason    InventoryMovementReason
  refId     String?

  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([productId])
  @@index([variantId])
}

model MarketingContact {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  firstName String?
  lastName  String?
  phone     String?
  town      String?
  birthdayDate    DateTime?
  anniversaryDate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant User @relation(fields: [tenantId], references: [id])

  consents                 MarketingConsent[]
  tags                     MarketingContactTag[]
  recipients               MarketingCampaignRecipient[]
  events                   MarketingEmailEvent[]
  preferences              MarketingContactPreference[]
  automationStates         MarketingAutomationState[]
  automationStepExecutions MarketingAutomationStepExecution[]
  automationRuns           MarketingAutomationRun[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model MarketingConsent {
  id                String                 @id @default(cuid())
  tenantId          String
  contactId         String
  status            MarketingConsentStatus
  lawfulBasis       MarketingLawfulBasis
  source            MarketingConsentSource
  capturedAt        DateTime
  capturedIp        String?
  capturedUserAgent String?

  contact MarketingContact @relation(fields: [contactId], references: [id])

  @@unique([tenantId, contactId])
  @@index([tenantId])
}

model MarketingImportJob {
  id        String                 @id @default(cuid())
  tenantId  String
  filename  String?
  status    MarketingImportJobStatus
  createdAt DateTime               @default(now())
  finishedAt DateTime?
  totalRows Int                    @default(0)
  imported  Int                    @default(0)
  skipped   Int                    @default(0)
  errorsJson Json?

  tenant    User                   @relation(fields: [tenantId], references: [id])
  rowErrors MarketingImportRowError[]

  @@index([tenantId])
}

model MarketingImportRowError {
  id        String            @id @default(cuid())
  jobId     String
  rowNumber Int
  email     String?
  error     String

  job MarketingImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}

model MarketingSuppression {
  id        String                   @id @default(cuid())
  tenantId  String
  email     String
  type      MarketingSuppressionType
  reason    String?
  createdAt DateTime                 @default(now())

  tenant User @relation(fields: [tenantId], references: [id])

  @@index([tenantId, email])
  @@index([tenantId])
}

model MarketingTag {
  id       String @id @default(cuid())
  tenantId String
  name     String

  tenant   User                  @relation(fields: [tenantId], references: [id])
  contacts MarketingContactTag[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model MarketingContactTag {
  tenantId  String
  contactId String
  tagId     String

  contact MarketingContact @relation(fields: [contactId], references: [id])
  tag     MarketingTag     @relation(fields: [tagId], references: [id])

  @@id([contactId, tagId])
  @@index([tenantId])
}

model MarketingTemplate {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  subject   String
  fromName  String
  fromEmail String
  replyTo   String?
  previewText String?
  mjmlBody  String   @db.Text
  isLocked  Boolean  @default(false)
  lockedAt  DateTime?
  lockedByUserId String?
  lockReason String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          User                      @relation(fields: [tenantId], references: [id])
  lockedBy       User?                     @relation("MarketingTemplateLockedBy", fields: [lockedByUserId], references: [id])
  campaigns       MarketingCampaign[]
  automationSteps MarketingAutomationStep[]
  versions        MarketingTemplateVersion[]
  changeRequests  MarketingTemplateChangeRequest[]

  @@index([tenantId])
}

model MarketingTemplateVersion {
  id         String   @id @default(cuid())
  templateId String
  version    Int
  name       String
  subject    String
  previewText String?
  fromName   String
  fromEmail  String
  replyTo    String?
  mjmlBody   String   @db.Text
  createdByUserId String?
  createdAt  DateTime @default(now())

  template MarketingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdBy User? @relation("MarketingTemplateVersionAuthor", fields: [createdByUserId], references: [id])

  @@index([templateId, version])
}

model MarketingTemplateChangeRequest {
  id         String   @id @default(cuid())
  tenantId   String
  templateId String
  status     MarketingTemplateChangeStatus @default(PENDING)
  payload    Json
  message    String?
  requestedByUserId String?
  approvedByUserId  String?
  requestedAt DateTime @default(now())
  reviewedAt DateTime?

  tenant     User             @relation(fields: [tenantId], references: [id])
  template   MarketingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  requestedBy User?           @relation("MarketingTemplateChangeRequestedBy", fields: [requestedByUserId], references: [id])
  approvedBy  User?           @relation("MarketingTemplateChangeApprovedBy", fields: [approvedByUserId], references: [id])

  @@index([tenantId, status])
  @@index([templateId])
}

model MarketingEmailTemplate {
  id               String   @id @default(cuid())
  tenantId         String
  name             String
  subject          String
  showId           String?
  currentVersionId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant   User                         @relation(fields: [tenantId], references: [id])
  versions MarketingEmailTemplateVersion[]

  @@index([tenantId])
}

model MarketingEmailTemplateVersion {
  id         String   @id @default(cuid())
  templateId String
  version    Int
  document   Json
  html       String   @db.Text
  createdAt  DateTime @default(now())

  template MarketingEmailTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
}

model MarketingSegment {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  rules       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    User                @relation(fields: [tenantId], references: [id])
  campaigns MarketingCampaign[]

  @@index([tenantId])
}

model MarketingCampaign {
  id              String                  @id @default(cuid())
  tenantId        String
  name            String
  templateId      String
  segmentId       String
  type            MarketingCampaignType   @default(ONE_OFF)
  showId          String?
  status          MarketingCampaignStatus @default(DRAFT)
  scheduledFor    DateTime?
  scheduledByUserId String?
  approvedByUserId  String?
  approvedAt      DateTime?
  sentAt          DateTime?
  recipientsPreparedAt DateTime?
  sendLockedUntil DateTime?
  createdByUserId String
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  tenant     User                         @relation("MarketingCampaignTenant", fields: [tenantId], references: [id])
  template   MarketingTemplate            @relation(fields: [templateId], references: [id])
  segment    MarketingSegment             @relation(fields: [segmentId], references: [id])
  show       Show?                        @relation(fields: [showId], references: [id])
  createdBy  User                         @relation("MarketingCampaignCreatedBy", fields: [createdByUserId], references: [id])
  scheduledBy User?                       @relation("MarketingCampaignScheduledBy", fields: [scheduledByUserId], references: [id])
  approvedBy  User?                       @relation("MarketingCampaignApprovedBy", fields: [approvedByUserId], references: [id])
  recipients MarketingCampaignRecipient[]
  events     MarketingEmailEvent[]

  @@index([tenantId])
  @@index([showId])
}

model MarketingCampaignRecipient {
  id         String                   @id @default(cuid())
  tenantId   String
  campaignId String
  contactId  String
  email      String
  status     MarketingRecipientStatus @default(PENDING)
  errorText  String?
  sentAt     DateTime?
  retryAt    DateTime?
  retryCount Int                      @default(0)
  lastAttemptAt DateTime?
  createdAt  DateTime                 @default(now())

  campaign MarketingCampaign @relation(fields: [campaignId], references: [id])
  contact  MarketingContact  @relation(fields: [contactId], references: [id])

  @@unique([tenantId, campaignId, contactId])
  @@index([tenantId, campaignId])
}

model MarketingDailySendCounter {
  id        String   @id @default(cuid())
  tenantId  String
  day       DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant User @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, day])
  @@index([tenantId, day])
}

model MarketingWorkerState {
  id              String   @id
  lastWorkerRunAt DateTime?
  lastSendAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model MarketingEmailEvent {
  id         String                  @id @default(cuid())
  tenantId   String
  campaignId String
  contactId  String?
  email      String
  type       MarketingEmailEventType
  meta       Json?
  createdAt  DateTime                @default(now())

  campaign MarketingCampaign @relation(fields: [campaignId], references: [id])
  contact  MarketingContact? @relation(fields: [contactId], references: [id])

  @@index([tenantId, campaignId])
  @@index([tenantId])
}

model MarketingAutomation {
  id          String                         @id @default(cuid())
  tenantId    String
  name        String
  triggerType MarketingAutomationTriggerType
  triggerConfig Json?
  isEnabled   Boolean                        @default(true)
  createdAt   DateTime                       @default(now())
  updatedAt   DateTime                       @updatedAt

  tenant         User                               @relation(fields: [tenantId], references: [id])
  steps          MarketingAutomationStep[]
  states         MarketingAutomationState[]
  stepExecutions MarketingAutomationStepExecution[]
  runs           MarketingAutomationRun[]

  @@index([tenantId])
}

model MarketingAutomationStep {
  id             String @id @default(cuid())
  tenantId       String
  automationId   String
  stepType       MarketingAutomationStepType @default(SEND_EMAIL)
  delayMinutes   Int                         @default(0)
  templateId     String?
  conditionRules Json?
  stepConfig     Json?
  throttleMinutes Int                        @default(0)
  quietHoursStart Int?
  quietHoursEnd   Int?
  stepOrder      Int

  automation MarketingAutomation                @relation(fields: [automationId], references: [id])
  template   MarketingTemplate?                 @relation(fields: [templateId], references: [id])
  executions MarketingAutomationStepExecution[]

  @@unique([tenantId, automationId, stepOrder])
  @@index([tenantId])
}

model MarketingAutomationState {
  id           String                         @id @default(cuid())
  tenantId     String
  contactId    String
  automationId String
  runId        String?
  triggerKey   String                         @default("")
  currentStep  Int                            @default(0)
  nextRunAt    DateTime?
  status       MarketingAutomationStateStatus @default(ACTIVE)
  createdAt    DateTime                       @default(now())
  updatedAt    DateTime                       @updatedAt

  automation MarketingAutomation @relation(fields: [automationId], references: [id])
  contact    MarketingContact    @relation(fields: [contactId], references: [id])
  run        MarketingAutomationRun? @relation(fields: [runId], references: [id])

  @@unique([tenantId, contactId, automationId, triggerKey])
  @@index([tenantId, nextRunAt])
}

model MarketingAutomationStepExecution {
  id           String                        @id @default(cuid())
  tenantId     String
  automationId String
  stepId       String
  contactId    String
  triggerKey   String                        @default("")
  status       MarketingAutomationStepStatus @default(SENT)
  errorText    String?
  metadata     Json?
  sentAt       DateTime?
  createdAt    DateTime                      @default(now())

  automation MarketingAutomation     @relation(fields: [automationId], references: [id])
  step       MarketingAutomationStep @relation(fields: [stepId], references: [id])
  contact    MarketingContact        @relation(fields: [contactId], references: [id])

  @@unique([tenantId, contactId, stepId, triggerKey])
  @@index([tenantId])
}

model MarketingAutomationRun {
  id           String                         @id @default(cuid())
  tenantId     String
  automationId String
  contactId    String
  triggerType  MarketingAutomationTriggerType
  triggerKey   String                         @default("")
  status       MarketingAutomationStateStatus @default(ACTIVE)
  lastStep     Int                            @default(0)
  startedAt    DateTime                       @default(now())
  completedAt  DateTime?
  metadata     Json?

  automation MarketingAutomation @relation(fields: [automationId], references: [id])
  contact    MarketingContact    @relation(fields: [contactId], references: [id])
  states     MarketingAutomationState[]

  @@index([tenantId, automationId])
  @@index([tenantId, contactId])
  @@index([tenantId, status])
}

model MarketingPreferenceTopic {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isDefault   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      User                         @relation(fields: [tenantId], references: [id])
  preferences MarketingContactPreference[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model MarketingContactPreference {
  id        String                    @id @default(cuid())
  tenantId  String
  contactId String
  topicId   String
  status    MarketingPreferenceStatus @default(SUBSCRIBED)
  updatedAt DateTime                  @updatedAt

  contact MarketingContact         @relation(fields: [contactId], references: [id])
  topic   MarketingPreferenceTopic @relation(fields: [topicId], references: [id])

  @@unique([tenantId, contactId, topicId])
  @@index([tenantId])
}

model MarketingCheckoutEvent {
  id        String                  @id @default(cuid())
  tenantId  String
  orderId   String
  showId    String?
  email     String?
  status    MarketingCheckoutStatus @default(STARTED)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  tenant User @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, orderId])
  @@index([tenantId, status])
}

model MarketingAuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  actorUserId String?
  actorEmail  String?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  tenant User @relation(fields: [tenantId], references: [id])
  actor  User? @relation("MarketingAuditActor", fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@index([actorUserId, createdAt])
}

model MarketingRoleAssignment {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      MarketingGovernanceRole @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant User @relation("MarketingRoleTenant", fields: [tenantId], references: [id])
  user   User @relation("MarketingRoleAssignee", fields: [userId], references: [id])

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  actorEmail  String?
  action      String
  targetType  String?
  targetId    String?
  metadataJson Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  actor User? @relation("AdminAuditActor", fields: [actorUserId], references: [id])

  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@index([targetType, targetId])
}

model OrderNote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  body String

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  createdById String?
  createdBy   User?   @relation("OrderNoteAuthor", fields: [createdById], references: [id])

  @@index([orderId])
  @@index([createdAt])
}

model OrderAuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action   OrderAuditAction
  metadata Json?

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  actorId String?
  actor   User?   @relation("OrderAuditActor", fields: [actorId], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@index([actorId])
}

model Refund {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  /// Kept for routes that read `amount`
  amount      Int
  /// Some code references `amountPence`; keep both for compatibility
  amountPence Int?
  reason      String?
  /// E.g. Stripe refund id or processor reference
  processorId String?
  /// Some routes refer to this key
  stripeId    String?

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])
}

model Ticket {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  showId      String
  amountPence Int
  quantity    Int    @default(1)

  orderId      String
  ticketTypeId String

  status     String?
  seatId     String?
  seatRef    String?
  serial     String?   @unique
  scannedAt  DateTime?
  holderName String?

  show       Show       @relation(fields: [showId], references: [id])
  order      Order      @relation(fields: [orderId], references: [id])
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id])
  userId     String?
  user       User?      @relation(fields: [userId], references: [id])
}

model SeatMap {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  version   Int     @default(1)
  isDefault Boolean @default(false)

  // NEW FIELDS
  isTemplate      Boolean @default(false)
  createdByUserId String?

  layout Json?

  showId  String
  venueId String?

  show        Show                 @relation(fields: [showId], references: [id])
  venue       Venue?               @relation(fields: [venueId], references: [id])
  seats       Seat[]
  zones       Zone[]
  allocations ExternalAllocation[]
}

model Zone {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  label String
  level String?

  seatMapId String
  seatMap   SeatMap @relation(fields: [seatMapId], references: [id])

  seats Seat[]
}

model Seat {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seatMapId       String
  seatMap         SeatMap          @relation(fields: [seatMapId], references: [id])
  allocationSeats AllocationSeat[]

  /// Basic coordinates
  row    String
  number Int

  /// Denormalised / optional fields referenced by routes
  rowLabel   String?
  seatNumber Int?
  label      String?
  kind       String?
  level      String?

  status SeatStatus @default(AVAILABLE)
  zoneId String?
  zone   Zone?      @relation(fields: [zoneId], references: [id])
}

model ExternalAllocation {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  showId           String
  seatMapId        String?
  source           String
  label            String?
  externalPlatform String?
  contactEmail     String?
  quantity         Int

  show    Show             @relation(fields: [showId], references: [id])
  seatMap SeatMap?         @relation(fields: [seatMapId], references: [id])
  seats   AllocationSeat[]
}

model AllocationSeat {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  allocationId String
  seatId       String
  rowLabel     String?
  seatNumber   Int?
  level        String?

  allocation ExternalAllocation @relation(fields: [allocationId], references: [id])
  seat       Seat               @relation(fields: [seatId], references: [id])
}

model CrmSegment {
  id             String   @id @default(cuid())
  organiserId    String
  name           String
  description    String?
  definitionJson Json
  lastRunAt      DateTime?
  archivedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organiser User @relation(fields: [organiserId], references: [id])
  members   CrmSegmentMember[]

  @@index([organiserId])
}

model CrmSegmentMember {
  id            String   @id @default(cuid())
  segmentId     String
  customerId    String?
  customerEmail String
  createdAt     DateTime @default(now())

  segment  CrmSegment @relation(fields: [segmentId], references: [id])
  customer User?      @relation(fields: [customerId], references: [id])

  @@unique([segmentId, customerEmail])
  @@index([segmentId])
}

model CrmTag {
  id          String   @id @default(cuid())
  organiserId String
  name        String
  colour      String?
  createdAt   DateTime @default(now())

  organiser User @relation("CrmTagOrganiser", fields: [organiserId], references: [id])
  customers CrmCustomerTag[]

  @@index([organiserId])
}

model CrmCustomerTag {
  id            String   @id @default(cuid())
  organiserId   String
  customerId    String?
  customerEmail String
  tagId         String
  createdAt     DateTime @default(now())

  organiser User  @relation("CrmCustomerTagOrganiser", fields: [organiserId], references: [id])
  customer  User? @relation("CrmCustomerTagCustomer", fields: [customerId], references: [id])
  tag       CrmTag @relation(fields: [tagId], references: [id])

  @@unique([customerEmail, tagId])
  @@index([organiserId])
}

model CrmEventView {
  id            String        @id @default(cuid())
  organiserId   String
  showId        String
  eventType     ShowEventType
  customerId    String?
  customerEmail String?
  sessionId     String?
  viewedAt      DateTime      @default(now())
  source        String?

  organiser User  @relation("CrmEventViewOrganiser", fields: [organiserId], references: [id])
  show      Show  @relation(fields: [showId], references: [id])
  customer  User? @relation("CrmEventViewCustomer", fields: [customerId], references: [id])

  @@index([organiserId, showId])
  @@index([eventType, viewedAt])
}

model CrmSurvey {
  id          String           @id @default(cuid())
  organiserId String
  name        String
  showId      String?
  status      CrmSurveyStatus  @default(DRAFT)
  startsAt    DateTime?
  endsAt      DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  organiser User  @relation(fields: [organiserId], references: [id])
  show      Show? @relation(fields: [showId], references: [id])
  questions CrmSurveyQuestion[]
  responses CrmSurveyResponse[]

  @@index([organiserId])
}

model CrmSurveyQuestion {
  id          String   @id @default(cuid())
  surveyId    String
  type        String
  prompt      String
  optionsJson Json?
  sortOrder   Int      @default(0)

  survey CrmSurvey @relation(fields: [surveyId], references: [id])

  @@index([surveyId])
}

model CrmSurveyResponse {
  id            String   @id @default(cuid())
  surveyId      String
  customerId    String?
  customerEmail String?
  sessionId     String?
  submittedAt   DateTime @default(now())
  answersJson   Json

  survey   CrmSurvey @relation(fields: [surveyId], references: [id])
  customer User?     @relation(fields: [customerId], references: [id])

  @@index([surveyId])
}

model StoreTaxRate {
  id          String   @id @default(cuid())
  organiserId String
  name        String
  rateBps     Int
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  organiser User @relation(fields: [organiserId], references: [id])

  @@index([organiserId])
}

model StoreFulfilmentMethod {
  id          String            @id @default(cuid())
  organiserId String
  name        String
  type        StoreFulfilmentKind
  detailsJson Json?
  createdAt   DateTime @default(now())

  organiser User @relation(fields: [organiserId], references: [id])

  @@index([organiserId])
}

model StoreShowAddOn {
  id          String        @id @default(cuid())
  organiserId String
  showId      String
  productId   String
  mode        StoreAddOnMode
  isActive    Boolean       @default(true)
  maxPerOrder Int?
  sortOrder   Int           @default(0)

  organiser User    @relation(fields: [organiserId], references: [id])
  show      Show    @relation(fields: [showId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@index([organiserId])
  @@index([showId])
}

model StoreBundleRule {
  id             String                @id @default(cuid())
  organiserId    String
  name           String
  showId         String?
  productIdsJson Json
  discountType   StoreBundleDiscountType
  discountValue  Int
  startsAt       DateTime?
  endsAt         DateTime?
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  organiser User  @relation(fields: [organiserId], references: [id])
  show      Show? @relation(fields: [showId], references: [id])

  @@index([organiserId])
}

model SupportTicket {
  id                    String                 @id @default(cuid())
  organiserId           String
  customerId            String?
  orderId               String?
  showId                String?
  subject               String
  category              SupportTicketCategory
  status                SupportTicketStatus
  priority              SupportTicketPriority
  lastCustomerMessageAt DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  organiser       User  @relation("SupportTicketOrganiser", fields: [organiserId], references: [id])
  customer        User? @relation("SupportTicketCustomer", fields: [customerId], references: [id])
  order           Order? @relation(fields: [orderId], references: [id])
  show            Show? @relation(fields: [showId], references: [id])
  messages        SupportMessage[]
  attachments     SupportAttachment[]
  triageResults   SupportTriageResult[]
  suggestedReplies SupportSuggestedReply[]

  @@index([organiserId])
  @@index([status])
}

model SupportMessage {
  id         String                  @id @default(cuid())
  ticketId   String
  senderType SupportMessageSenderType
  body       String
  createdAt  DateTime @default(now())
  metaJson   Json?

  ticket SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model SupportAttachment {
  id        String   @id @default(cuid())
  ticketId  String
  filename  String
  url       String
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model SupportTriageResult {
  id                String   @id @default(cuid())
  ticketId          String
  suggestedCategory SupportTicketCategory
  suggestedPriority SupportTicketPriority
  suggestedNextStep String?
  createdAt         DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model SupportSuggestedReply {
  id        String   @id @default(cuid())
  ticketId  String
  draftBody String
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model ChatbotKnowledgeSource {
  id          String   @id @default(cuid())
  organiserId String
  type        String
  title       String
  content     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  organiser User @relation("ChatbotKnowledgeOrganiser", fields: [organiserId], references: [id])

  @@index([organiserId])
}

model ChatbotTranscript {
  id               String   @id @default(cuid())
  organiserId      String
  sessionId        String
  customerId       String?
  showId           String?
  startedAt        DateTime @default(now())
  endedAt          DateTime?
  transcriptJson   Json
  conversionHelped Boolean  @default(false)

  organiser User  @relation("ChatbotTranscriptOrganiser", fields: [organiserId], references: [id])
  customer  User? @relation("ChatbotTranscriptCustomer", fields: [customerId], references: [id])
  show      Show? @relation(fields: [showId], references: [id])

  @@index([organiserId])
}

model ChatbotEscalationRule {
  id          String   @id @default(cuid())
  organiserId String
  name        String
  matchJson   Json
  actionJson  Json
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())

  organiser User @relation("ChatbotEscalationOrganiser", fields: [organiserId], references: [id])

  @@index([organiserId])
}
