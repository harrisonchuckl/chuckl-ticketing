/// ===============================
/// Prisma schema for Chuckl Ticketing
/// ===============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

/// ===============================
/// Enums
/// ===============================

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum SeatStatus {
  AVAILABLE
  HELD
  SOLD
  BLOCKED
}

/// ===============================
/// Core models required by routes
/// ===============================

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  // If you don't use passwords, leave as optional
  passwordHash String?
  role       String?  // "admin" | "organiser" | etc.

  orders     Order[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([email])
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  address1  String?
  address2  String?
  city      String?
  postcode  String?
  country   String?
  capacity  Int?

  // Relations
  seatMaps  SeatMap[]
  shows     Show[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([name])
}

model Show {
  id        String   @id @default(cuid())

  venueId   String?
  venue     Venue?   @relation(fields: [venueId], references: [id])

  title       String?
  description String?
  imageUrl    String?

  // A lot of your routes use `date`, so include it explicitly.
  // If you also want startsAt, add it too; primary usage is `date`.
  date      DateTime
  // startsAt DateTime?

  // Relations
  ticketTypes         TicketType[]
  orders              Order[]
  seatMaps            SeatMap[]
  externalAllocations ExternalAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([date])
}

model TicketType {
  id        String   @id @default(cuid())

  showId    String
  show      Show     @relation(fields: [showId], references: [id], onDelete: Cascade)

  name        String
  // pricing (pence)
  pricePence  Int
  feePence    Int?      // optional per-type fee if you use it
  // inventory controls
  quantityTotal Int?
  quantitySold  Int?     @default(0)
  maxPerOrder   Int?

  isActive   Boolean @default(true)
  sortOrder  Int?     // for UI lists

  tickets    Ticket[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([showId])
  @@index([isActive])
}

model Order {
  id        String       @id @default(cuid())

  showId    String
  show      Show         @relation(fields: [showId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?        @relation(fields: [userId], references: [id])

  // customer identity (used in many routes/exports)
  email     String?

  // gateway references
  stripeId  String?

  status    OrderStatus  @default(PENDING)

  // Money fields (all pence) â€“ your routes read these names
  amountPence          Int     @default(0) // main amount (sometimes used as item amount)
  paymentFeePence      Int?    @default(0)
  platformFeePence     Int?    @default(0)
  organiserSharePence  Int?    @default(0)
  netPayoutPence       Int?    @default(0)

  // Totals you may still use elsewhere
  subtotalPence Int    @default(0)
  feesPence     Int    @default(0)
  totalPence    Int    @default(0)

  // Relations
  tickets   Ticket[]
  refunds   Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([showId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model Ticket {
  id           String     @id @default(cuid())

  orderId      String
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  showId       String
  show         Show       @relation(fields: [showId], references: [id], onDelete: Cascade)

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Restrict)

  // price at time of purchase (pence)
  amountPence  Int        @default(0)

  // quantity is referenced in multiple routes/exports
  quantity     Int        @default(1)

  // optional seat binding
  seatId       String?
  seat         Seat?      @relation(fields: [seatId], references: [id], onDelete: SetNull)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([orderId])
  @@index([showId])
  @@index([ticketTypeId])
}

/// ===============================
/// Your updated blocks (kept as requested)
/// ===============================

// ----------------------
// Refund (updated block)
// ----------------------
model Refund {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  /// Amount in pence (column mapped to amountPence)
  amount      Int      @map("amountPence")

  reason      String?
  processorId String?
  stripeId    String?

  // NEW - matches route usage
  createdBy   String?

  createdAt   DateTime @default(now())

  @@index([orderId])
}

// ----------------------
// SeatMap (updated block)
// ----------------------
model SeatMap {
  id        String   @id @default(cuid())
  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])
  venueId   String?
  venue     Venue?   @relation(fields: [venueId], references: [id])

  name      String
  version   Int?
  // NEW - matches route usage
  isDefault Boolean  @default(false)

  // routes create with a `layout` payload
  layout    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seats       Seat[]
  allocations ExternalAllocation[]
  zones       SeatMapZone[]

  @@index([showId])
  @@index([venueId])
}

// ------------------------------------
// ExternalAllocation (updated block)
// ------------------------------------
model ExternalAllocation {
  id        String   @id @default(cuid())

  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])

  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id])

  label     String

  // NEW - optional platform hint (e.g., "SeeTickets", "Ticketsolve")
  externalPlatform String?

  // NEW - used in routes when creating allocations
  contactEmail String?

  createdAt DateTime @default(now())

  seats AllocationSeat[]

  @@index([seatMapId])
  @@index([showId])
}

// ------------------------------------
// AllocationSeat (ensure seatNumber is STRING)
// ------------------------------------
model AllocationSeat {
  id           String   @id @default(cuid())
  seatId       String
  allocationId String

  allocation   ExternalAllocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  seat         Seat?              @relation(fields: [seatId], references: [id], onDelete: Cascade)

  rowLabel   String?
  seatNumber String?  // <- keep as string to support labels like "A12"
  level      String?

  createdAt  DateTime @default(now())

  @@index([allocationId])
  @@index([seatId])
}

// ------------------------------------
// Seat + SeatMapZone (expanded)
// ------------------------------------
model Seat {
  id        String   @id @default(cuid())

  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  // For flexible labels; your code reads label/kind/status/zoneId
  label     String?
  kind      String?       // e.g., "standard" | "wheelchair" | "aisle"

  rowLabel   String?
  seatNumber String?
  level      String?

  status     SeatStatus   @default(AVAILABLE)

  zoneId     String?
  zone       SeatMapZone? @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  isAvailable Boolean  @default(true)

  allocationSeats AllocationSeat[]
  // optional backref from tickets if bound
  tickets    Ticket[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([seatMapId])
  @@index([zoneId])
  @@index([rowLabel, seatNumber])
}

model SeatMapZone {
  id        String  @id @default(cuid())

  seatMapId String
  seatMap   SeatMap @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  name       String
  // Optional styling / pricing helpers
  colorHex   String?   // e.g. "#0ea5e9"
  pricePence Int?

  seats      Seat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seatMapId])
  @@index([name])
}
