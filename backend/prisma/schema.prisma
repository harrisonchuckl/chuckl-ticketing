// ---------- Prisma client + DB connection ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// Enums
// =========================

enum Role {
  ADMIN
  ORGANISER
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum TicketStatus {
  AVAILABLE
  RESERVED
  SOLD
  REFUNDED
  EXTERNAL_ALLOCATED
  USED         // needed by scanner route
}

enum SeatStatus {
  AVAILABLE
  UNAVAILABLE
  HELD
  RESERVED
  SOLD
  EXTERNAL_ALLOCATED
}

// =========================
// Core models
// =========================

model User {
  id                 String       @id @default(cuid())
  email              String       @unique
  name               String?
  password           String?      // legacy (some routes read this)
  passwordHash       String?
  role               Role         @default(CUSTOMER)

  organiserSplitBps  Int?         // legacy field used in exports/checkout/etc

  orders             Order[]
  seatHolds          SeatHold[]
  uploads            Upload[]

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model Venue {
  id                String             @id @default(cuid())
  name              String
  capacity          Int?               // legacy
  // legacy convenience field some routes select as 'address'
  address           String?
  // granular address fields (optional)
  city              String?
  postcode          String?
  addressLine1      String?
  addressLine2      String?
  country           String?

  shows             Show[]
  seatmapTemplates  SeatmapTemplate[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Show {
  id              String        @id @default(cuid())
  title           String
  date            DateTime
  status          String?                // DRAFT / ON_SALE / CLOSED, etc.

  // both fields kept for compatibility with different routes
  description     String?
  descriptionHtml String?

  imageUrl        String?

  venueId         String?
  venue           Venue?        @relation(fields: [venueId], references: [id])

  ticketTypes     TicketType[]
  tickets         Ticket[]
  seats           ShowSeat[]
  orderItems      OrderItem[]
  seatHolds       SeatHold[]
  orders          Order[]       // legacy: some routes expect Show.count({ select: { orders: true }})

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([venueId])
  @@index([date])
}

model TicketType {
  id              String     @id @default(cuid())
  showId          String
  show            Show       @relation(fields: [showId], references: [id])

  name            String

  // legacy integer price used across routes
  pricePence      Int        @default(0)

  // newer decimal fields retained as well
  facePrice       Decimal    @db.Decimal(10, 2)
  fee             Decimal    @db.Decimal(10, 2) @default(0)

  allocationTotal Int        @default(0)
  available       Int        @default(0)        // some routes read `available`
  maxPerOrder     Int?

  tickets         Ticket[]
  orderItems      OrderItem[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([showId])
}

model Ticket {
  id          String        @id @default(cuid())

  showId      String?
  show        Show?         @relation(fields: [showId], references: [id])

  typeId      String?
  type        TicketType?   @relation(fields: [typeId], references: [id])

  orderId     String?
  order       Order?        @relation(fields: [orderId], references: [id])

  seatId      String?
  seat        ShowSeat?     @relation(fields: [seatId], references: [id])

  status      TicketStatus  @default(AVAILABLE)
  pricePaid   Decimal?      @db.Decimal(10, 2)

  // scanner + lookup legacy fields
  serial      String?       @unique
  scannedAt   DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([showId])
  @@index([typeId])
  @@index([orderId])
  @@index([seatId])
}

model Order {
  id                  String        @id @default(cuid())
  userId              String?
  user                User?         @relation(fields: [userId], references: [id])

  email               String
  status              OrderStatus   @default(PENDING)

  // newer fields already used in some routes
  totalGross          Decimal       @db.Decimal(10, 2) @default(0)
  totalFees           Decimal       @db.Decimal(10, 2) @default(0)

  // legacy integer financial fields (used heavily in routes)
  amountPence         Int?          // order total in pence
  platformFeePence    Int?
  organiserSharePence Int?
  paymentFeePence     Int?
  netPayoutPence      Int?
  stripeId            String?

  // legacy: some routes treat an order as tied to a single show
  showId              String?
  show                Show?         @relation(fields: [showId], references: [id])

  // legacy: some routes read quantity directly on Order
  quantity            Int?

  items               OrderItem[]
  tickets             Ticket[]
  refunds             Refund[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([userId])
  @@index([showId])
}

model OrderItem {
  id            String      @id @default(cuid())
  orderId       String
  order         Order       @relation(fields: [orderId], references: [id])

  showId        String?
  show          Show?       @relation(fields: [showId], references: [id])

  ticketTypeId  String?
  ticketType    TicketType? @relation(fields: [ticketTypeId], references: [id])

  quantity      Int         @default(1)
  unitPrice     Decimal     @db.Decimal(10, 2)
  fees          Decimal     @db.Decimal(10, 2) @default(0)
  amountPence   Int?        // legacy helper

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([orderId])
  @@index([showId])
  @@index([ticketTypeId])
}

model Refund {
  id           String   @id @default(cuid())
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amountPence  Int
  reason       String?
  processorId  String?  // e.g. Stripe refund id
  createdAt    DateTime @default(now())

  @@index([orderId])
}

model Upload {
  id           String   @id @default(cuid())
  key          String
  url          String   @unique
  ownerUserId  String?
  owner        User?    @relation(fields: [ownerUserId], references: [id])

  createdAt    DateTime @default(now())
}

// =========================
// Seating templates & show seats (newer system)
// =========================

model SeatmapTemplate {
  id        String            @id @default(cuid())
  venueId   String
  venue     Venue             @relation(fields: [venueId], references: [id])
  name      String
  sections  SeatmapSection[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([venueId])
}

model SeatmapSection {
  id         String           @id @default(cuid())
  templateId String
  template   SeatmapTemplate  @relation(fields: [templateId], references: [id])

  name      String
  level     String?
  sortIndex Int               @default(0)
  originX   Int               @default(0)
  originY   Int               @default(0)

  seats     SeatTemplate[]

  @@index([templateId])
}

model SeatTemplate {
  id         String          @id @default(cuid())
  sectionId  String
  section    SeatmapSection  @relation(fields: [sectionId], references: [id])

  rowLabel   String
  seatNumber Int
  label      String
  x          Int
  y          Int
  w          Int              @default(18)
  h          Int              @default(18)
  tags       Json?

  @@index([sectionId])
}

model ShowSeat {
  id        String     @id @default(cuid())
  showId    String
  show      Show       @relation(fields: [showId], references: [id])

  section    String?
  rowLabel   String
  seatNumber Int
  label      String
  x          Int
  y          Int
  w          Int        @default(18)
  h          Int        @default(18)

  status        SeatStatus @default(AVAILABLE)
  allocationRef String?

  holdId    String?
  hold      SeatHold?   @relation(fields: [holdId], references: [id])

  tickets   Ticket[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([showId, label])
  @@index([showId, status])
  @@index([holdId])
}

model SeatHold {
  id         String    @id @default(cuid())
  showId     String
  show       Show      @relation(fields: [showId], references: [id])

  userId     String?
  user       User?     @relation(fields: [userId], references: [id])

  expiresAt  DateTime
  createdAt  DateTime  @default(now())

  seats      ShowSeat[]

  @@index([showId])
  @@index([userId])
}

// =========================
// Legacy seatmap models (to satisfy existing routes)
// =========================

model SeatMap {
  id        String   @id @default(cuid())
  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seats     Seat[]
  allocations ExternalAllocation[]

  @@index([showId])
}

model Seat {
  id        String   @id @default(cuid())
  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id])

  label     String
  row       String?
  number    Int?
  x         Int?
  y         Int?
  status    SeatStatus @default(AVAILABLE)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  allocationSeats AllocationSeat[]
}

model ExternalAllocation {
  id        String   @id @default(cuid())
  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])

  name      String
  createdAt DateTime @default(now())

  seats     AllocationSeat[]
}

model AllocationSeat {
  id           String            @id @default(cuid())
  allocationId String
  allocation   ExternalAllocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)

  seatId       String
  seat         Seat               @relation(fields: [seatId], references: [id], onDelete: Cascade)

  createdAt    DateTime          @default(now())

  @@index([allocationId])
  @@index([seatId])
}
