/// ===============================
/// Prisma schema for Chuckl Ticketing
/// ===============================

generator client {
  provider = "prisma-client-js"
  // previewFeatures = []
}

datasource db {
  provider = "postgresql"
  // Prisma only needs this env var to exist during `prisma generate`.
  // Your real runtime URL should be provided at runtime/deploy.
  url = env("DB_URL")
}

/// ======================================================================
/// CORE MODELS (minimal but functional so `prisma generate` passes)
/// You can flesh these out with more fields/indexes later as needed.
/// ======================================================================

model Order {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Example money fields (pence for accuracy)
  subtotalPence Int     @default(0)
  feesPence     Int     @default(0)
  totalPence    Int     @default(0)

  // Relations
  refunds Refund[]

  @@index([createdAt])
}

model Show {
  id         String    @id @default(cuid())
  venueId    String?
  venue      Venue?    @relation(fields: [venueId], references: [id])
  title      String?
  startsAt   DateTime?

  // Relations
  seatMaps          SeatMap[]
  externalAllocations ExternalAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([startsAt])
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  address1  String?
  address2  String?
  city      String?
  postcode  String?
  country   String?

  // Relations
  seatMaps  SeatMap[]
  shows     Show[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([name])
}

model Seat {
  id        String   @id @default(cuid())

  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  // Labels kept as strings so things like "A12" / "Balcony-7" work
  rowLabel   String?
  seatNumber String?
  level      String?

  isAvailable Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional: connect allocation seats back to physical seat (not required)
  allocationSeats AllocationSeat[]

  @@index([seatMapId])
  @@index([rowLabel, seatNumber])
}

model SeatMapZone {
  id        String  @id @default(cuid())

  seatMapId String
  seatMap   SeatMap @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  name       String
  // Optional styling / pricing helpers
  colorHex   String?   // e.g. "#0ea5e9"
  pricePence Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seatMapId])
  @@index([name])
}

/// ======================================================================
/// YOUR UPDATED BLOCKS (from your message)
/// ======================================================================

// ----------------------
// Refund (updated block)
// ----------------------
model Refund {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  /// Amount in pence (column mapped to amountPence)
  amount      Int      @map("amountPence")

  reason      String?
  processorId String?
  stripeId    String?

  // NEW - matches route usage
  createdBy   String?

  createdAt   DateTime @default(now())

  @@index([orderId])
}

// ----------------------
// SeatMap (updated block)
// ----------------------
model SeatMap {
  id        String   @id @default(cuid())
  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])
  venueId   String?
  venue     Venue?   @relation(fields: [venueId], references: [id])

  name      String
  version   Int?
  // NEW - matches route usage
  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seats       Seat[]
  allocations ExternalAllocation[]
  zones       SeatMapZone[]

  @@index([showId])
  @@index([venueId])
}

// ------------------------------------
// ExternalAllocation (updated block)
// ------------------------------------
model ExternalAllocation {
  id        String   @id @default(cuid())

  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])

  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id])

  label     String

  // NEW - optional platform hint (e.g., "SeeTickets", "Ticketsolve")
  externalPlatform String?

  createdAt DateTime @default(now())

  seats AllocationSeat[]

  @@index([seatMapId])
  @@index([showId])
}

// ------------------------------------
// AllocationSeat (ensure seatNumber is STRING)
// ------------------------------------
model AllocationSeat {
  id           String   @id @default(cuid())
  seatId       String
  allocationId String

  allocation   ExternalAllocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  seat         Seat?              @relation(fields: [seatId], references: [id], onDelete: Cascade)

  rowLabel   String?
  seatNumber String?  // <- keep as string to support labels like "A12"
  level      String?

  createdAt  DateTime @default(now())

  @@index([allocationId])
  @@index([seatId])
}
