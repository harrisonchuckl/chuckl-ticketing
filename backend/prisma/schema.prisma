/// ===============================
/// Prisma schema for Chuckl Ticketing
/// ===============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

/// ===============================
/// Enums
/// ===============================

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum SeatStatus {
  AVAILABLE
  HELD
  SOLD
  BLOCKED
}

/// ===============================
/// Core models
/// ===============================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String?
  role         String?

  orders       Order[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  address1  String?
  address2  String?
  city      String?
  postcode  String?
  country   String?
  capacity  Int?

  seatMaps  SeatMap[]
  shows     Show[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([name])
}

model Show {
  id        String   @id @default(cuid())

  venueId   String?
  venue     Venue?   @relation(fields: [venueId], references: [id])

  title       String?
  description String?
  imageUrl    String?

  // Primary date used across routes
  date      DateTime

  // Relations
  ticketTypes         TicketType[]
  orders              Order[]
  seatMaps            SeatMap[]
  externalAllocations ExternalAllocation[]
  tickets             Ticket[]          // <-- added to satisfy Ticket.show back-relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([date])
}

model TicketType {
  id           String   @id @default(cuid())
  showId       String
  show         Show     @relation(fields: [showId], references: [id], onDelete: Cascade)

  name         String
  pricePence   Int
  feePence     Int?
  quantityTotal Int?
  quantitySold  Int?    @default(0)
  maxPerOrder   Int?
  isActive     Boolean  @default(true)
  sortOrder    Int?

  tickets      Ticket[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([showId])
  @@index([isActive])
}

model Order {
  id        String       @id @default(cuid())

  showId    String
  show      Show         @relation(fields: [showId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?        @relation(fields: [userId], references: [id])

  email     String?
  stripeId  String?

  status    OrderStatus  @default(PENDING)

  // Money (pence)
  amountPence          Int  @default(0)
  paymentFeePence      Int? @default(0)
  platformFeePence     Int? @default(0)
  organiserSharePence  Int? @default(0)
  netPayoutPence       Int? @default(0)

  // Legacy/other totals used elsewhere
  subtotalPence Int @default(0)
  feesPence     Int @default(0)
  totalPence    Int @default(0)

  tickets   Ticket[]
  refunds   Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([showId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model Ticket {
  id           String     @id @default(cuid())

  orderId      String
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  showId       String
  show         Show       @relation(fields: [showId], references: [id], onDelete: Cascade)

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Restrict)

  amountPence  Int        @default(0)
  quantity     Int        @default(1)

  seatId       String?
  seat         Seat?      @relation(fields: [seatId], references: [id], onDelete: SetNull)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([orderId])
  @@index([showId])
  @@index([ticketTypeId])
}

/// ===============================
/// Your updated blocks (kept)
/// ===============================

model Refund {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  /// Amount in pence (column mapped to amountPence)
  amount      Int      @map("amountPence")

  reason      String?
  processorId String?
  stripeId    String?

  // NEW - matches route usage
  createdBy   String?

  createdAt   DateTime @default(now())

  @@index([orderId])
}

model SeatMap {
  id        String   @id @default(cuid())
  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])
  venueId   String?
  venue     Venue?   @relation(fields: [venueId], references: [id])

  name      String
  version   Int?
  isDefault Boolean  @default(false)

  // routes post a layout JSON
  layout    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seats       Seat[]
  allocations ExternalAllocation[]
  zones       SeatMapZone[]

  @@index([showId])
  @@index([venueId])
}

model ExternalAllocation {
  id        String   @id @default(cuid())

  showId    String?
  show      Show?    @relation(fields: [showId], references: [id])

  seatMapId String
  seatMap   SeatMap  @relation(fields: [seatMapId], references: [id])

  label     String

  externalPlatform String?
  contactEmail     String?

  createdAt DateTime @default(now())

  seats AllocationSeat[]

  @@index([seatMapId])
  @@index([showId])
}

model AllocationSeat {
  id           String   @id @default(cuid())
  seatId       String
  allocationId String

  allocation   ExternalAllocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  seat         Seat?              @relation(fields: [seatId], references: [id], onDelete: Cascade)

  rowLabel   String?
  seatNumber String?
  level      String?

  createdAt  DateTime @default(now())

  @@index([allocationId])
  @@index([seatId])
}

model Seat {
  id         String      @id @default(cuid())

  seatMapId  String
  seatMap    SeatMap     @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  label      String?
  kind       String?

  rowLabel   String?
  seatNumber String?
  level      String?

  status     SeatStatus  @default(AVAILABLE)

  zoneId     String?
  zone       SeatMapZone? @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  isAvailable Boolean @default(true)

  allocationSeats AllocationSeat[]
  tickets     Ticket[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([seatMapId])
  @@index([zoneId])
  @@index([rowLabel, seatNumber])
}

model SeatMapZone {
  id        String  @id @default(cuid())

  seatMapId String
  seatMap   SeatMap @relation(fields: [seatMapId], references: [id], onDelete: Cascade)

  name       String
  colorHex   String?
  pricePence Int?

  seats      Seat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seatMapId])
  @@index([name])
}
