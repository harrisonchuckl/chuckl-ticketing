generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// Enums
// =========================

enum Role {
  ADMIN
  ORGANISER
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum TicketStatus {
  AVAILABLE
  RESERVED
  SOLD
  REFUNDED
  EXTERNAL_ALLOCATED
  USED
}

enum SeatStatus {
  AVAILABLE
  UNAVAILABLE
  HELD
  RESERVED
  SOLD
  EXTERNAL_ALLOCATED
}

// =========================
/* Core models */
// =========================

model User {
  id                 String       @id @default(cuid())
  email              String       @unique
  name               String?
  password           String?
  passwordHash       String?
  role               Role         @default(CUSTOMER)

  organiserSplitBps  Int?

  // inverse relations
  orders             Order[]
  seatHolds          SeatHold[]
  uploads            Upload[]
  tickets            Ticket[]     // <â€” added inverse for Ticket.user

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model Venue {
  id                String             @id @default(cuid())
  name              String
  capacity          Int?
  address           String?
  city              String?
  postcode          String?
  addressLine1      String?
  addressLine2      String?
  country           String?

  shows             Show[]
  seatmapTemplates  SeatmapTemplate[]
  seatMaps          SeatMap[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Show {
  id              String        @id @default(cuid())
  title           String
  date            DateTime
  status          String?

  description     String?
  descriptionHtml String?

  imageUrl        String?

  venueId         String?
  venue           Venue?        @relation(fields: [venueId], references: [id])

  ticketTypes     TicketType[]
  tickets         Ticket[]
  seats           ShowSeat[]
  orderItems      OrderItem[]
  seatHolds       SeatHold[]
  orders          Order[]

  // inverse for legacy seat map
  seatMaps        SeatMap[]

  // external allocations (legacy compatibility)
  externalAllocations ExternalAllocation[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([venueId])
  @@index([date])
}

model TicketType {
  id              String     @id @default(cuid())
  showId          String
  show            Show       @relation(fields: [showId], references: [id])

  name            String
  pricePence      Int        @default(0)

  facePrice       Decimal    @db.Decimal(10, 2)
  fee             Decimal    @db.Decimal(10, 2) @default(0)

  allocationTotal Int?
  available       Int?
  maxPerOrder     Int?

  tickets         Ticket[]
  orderItems      OrderItem[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([showId])
}

model Ticket {
  id          String        @id @default(cuid())

  showId      String?
  show        Show?         @relation(fields: [showId], references: [id])

  typeId      String?
  type        TicketType?   @relation(fields: [typeId], references: [id])

  orderId     String?
  order       Order?        @relation(fields: [orderId], references: [id])

  seatId      String?
  seat        ShowSeat?     @relation(fields: [seatId], references: [id])

  status      TicketStatus  @default(AVAILABLE)
  pricePaid   Decimal?      @db.Decimal(10, 2)

  serial      String?       @unique
  scannedAt   DateTime?

  // legacy field used in email/mailer services
  holderName  String?

  // link to purchaser (optional)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([showId])
  @@index([typeId])
  @@index([orderId])
  @@index([seatId])
}

model Order {
  id                  String        @id @default(cuid())
  userId              String?
  user                User?         @relation(fields: [userId], references: [id])

  // optional so creation can happen before attaching an email
  email               String?

  status              OrderStatus   @default(PENDING)

  totalGross          Decimal       @db.Decimal(10, 2) @default(0)
  totalFees           Decimal       @db.Decimal(10, 2) @default(0)

  amountPence         Int?
  platformFeePence    Int?
  organiserSharePence Int?
  paymentFeePence     Int?
  netPayoutPence      Int?
  stripeId            String?

  showId              String?
  show                Show?         @relation(fields: [showId], references: [id])

  quantity            Int?

  items               OrderItem[]
  tickets             Ticket[]
  refunds             Refund[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([userId])
  @@index([showId])
}

model OrderItem {
  id            String      @id @default(cuid())
  orderId       String
  order         Order       @relation(fields: [orderId], references: [id])

  showId        String?
  show          Show?       @relation(fields: [showId], references: [id])

  ticketTypeId  String?
  ticketType    TicketType? @relation(fields: [ticketTypeId], references: [id])

  quantity      Int         @default(1)
  unitPrice     Decimal     @db.Decimal(10, 2)
  fees          Decimal     @db.Decimal(10, 2) @default(0)
  amountPence   Int?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([orderId])
  @@index([showId])
  @@index([ticketTypeId])
}

model Refund {
  id           String   @id @default(cuid())
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // keep column name amountPence but expose as amount in the client
  amount       Int      @map("amountPence")

  reason       String?
  processorId  String?
  createdAt    DateTime @default(now())

  @@index([orderId])
}

model Upload {
  id           String   @id @default(cuid())
  key          String
  url          String   @unique
  ownerUserId  String?
  owner        User?    @relation(fields: [ownerUserId], references: [id])

  createdAt    DateTime @default(now())
}

// =========================
// Seating templates & show seats (newer system)
// =========================

model SeatmapTemplate {
  id        String            @id @default(cuid())
  venueId   String
  venue     Venue             @relation(fields: [venueId], references: [id])
  name      String
  sections  SeatmapSection[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([venueId])
}

model SeatmapSection {
  id         String           @id @default(cuid())
  templateId String
  template   SeatmapTemplate  @relation(fields: [templateId], references: [id])

  name      String
  level     String?
  sortIndex Int               @default(0)
  originX   Int               @default(0)
  originY   Int               @default(0)

  seats     SeatTemplate[]

  @@index([templateId])
}

model SeatTemplate {
  id         String          @id @default(cuid())
  sectionId  String
  section    SeatmapSection  @relation(fields: [sectionId], references: [id])

  rowLabel   String
  seatNumber Int
  label      String
  x          Int
  y          Int
  w          Int              @default(18)
  h          Int              @default(18)
  tags       Json?

  @@index([sectionId])
}

model ShowSeat {
  id        String     @id @default(cuid())
  showId    String
  show      Show       @relation(fields: [showId], references: [id])

  section    String?
  rowLabel   String
  seatNumber Int
  label      String
  x          Int
  y          Int
  w          Int        @default(18)
  h          Int        @default(18)

  status        SeatStatus @default(AVAILABLE)
  allocationRef String?

  holdId    String?
  hold      SeatHold?   @relation(fields: [holdId], references: [id])

  tickets   Ticket[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([showId, label])
  @@index([showId, status])
  @@index([holdId])
}

model SeatHold {
  id         String    @id @default(cuid())
  showId     String
  show       Show      @relation(fields: [showId], references: [id])

  userId     String?
  user       User?     @relation(fields: [userId], references: [id])

  expiresAt  DateTime
  createdAt  DateTime  @default(now())

  seats      ShowSeat[]

  @@index([showId])
  @@index([userId])
}

// =========================
// Legacy seatmaps (compat)
// =========================

model SeatMap {
  id           String   @id @default(cuid())

  showId       String?
  show         Show?    @relation(fields: [showId], references: [id])

  // legacy routes sometimes set seat maps per-venue
  venueId      String?
  venue        Venue?   @relation(fields: [venueId], references: [id])

  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  seats        Seat[]
  allocations  ExternalAllocation[]
  zones        SeatMapZone[]

  @@index([showId])
  @@index([venueId])
}

model Seat {
  id         String   @id @default(cuid())
  seatMapId  String
  seatMap    SeatMap  @relation(fields: [seatMapId], references: [id])

  label      String
  rowLabel   String?
  seatNumber Int?

  x          Int?
  y          Int?
  status     SeatStatus @default(AVAILABLE)

  // legacy fields referenced in routes
  level      String?
  kind       String?
  zoneId     String?
  zone       SeatMapZone? @relation(fields: [zoneId], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  allocationSeats AllocationSeat[]
}

model SeatMapZone {
  id        String  @id @default(cuid())
  seatMapId String
  seatMap   SeatMap @relation(fields: [seatMapId], references: [id])

  label     String
  createdAt DateTime @default(now())

  seats     Seat[]
}

model ExternalAllocation {
  id          String   @id @default(cuid())

  // many routes filter by showId
  showId      String?
  show        Show?    @relation(fields: [showId], references: [id])

  seatMapId   String
  seatMap     SeatMap  @relation(fields: [seatMapId], references: [id])

  name        String
  createdAt   DateTime @default(now())

  seats       AllocationSeat[]

  @@index([seatMapId])
  @@index([showId])
}

model AllocationSeat {
  id           String             @id @default(cuid())
  allocationId String
  allocation   ExternalAllocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)

  seatId       String
  seat         Seat               @relation(fields: [seatId], references: [id], onDelete: Cascade)

  createdAt    DateTime           @default(now())

  @@index([allocationId])
  @@index([seatId])
}
