name: Update Single File

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: "Path of the file to write (e.g. backend/src/routes/auth.ts)"
        required: true
        type: string
      branch_name:
        description: "Branch to create (e.g. chore/file-update-YYYYMMDD-HHMM)"
        required: true
        type: string
      commit_message:
        description: "Commit message"
        required: true
        type: string
      content_b64:
        description: "Base64-encoded file content"
        required: true
        type: string
      open_pr:
        description: "Open a pull request to default branch?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create branch
        run: |
          git config user.name "chuckl-bot"
          git config user.email "actions@users.noreply.github.com"
          git checkout -b "${{ inputs.branch_name }}"

      - name: Write file from base64
        shell: bash
        run: |
          mkdir -p "$(dirname "${{ inputs.file_path }}")"
          echo "${{ inputs.content_b64 }}" | base64 -d > "${{ inputs.file_path }}"
          echo "Wrote ${{ inputs.file_path }}"

      - name: Commit changes
        run: |
          git add "${{ inputs.file_path }}"
          git commit -m "${{ inputs.commit_message }}"
          git push --set-upstream origin "${{ inputs.branch_name }}"

      - name: Open PR
        if: ${{ inputs.open_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ inputs.branch_name }}
          title: ${{ inputs.commit_message }}
          body: "Automated update via workflow"
          base: ${{ github.event.repository.default_branch }}
          labels: automated
