name: Update Multiple Files

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: "Branch to create (e.g. chore/bulk-update-YYYYMMDD-HHMM)"
        required: true
        type: string
      commit_message:
        description: "Commit message"
        required: true
        type: string
      files_json:
        description: |
          JSON map of { "path/to/file.ts": "BASE64_CONTENT", "another/path": "BASE64_CONTENT" }
        required: true
        type: string
      open_pr:
        description: "Open a pull request to default branch?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create branch
        run: |
          git config user.name "chuckl-bot"
          git config user.email "actions@users.noreply.github.com"
          git checkout -b "${{ inputs.branch_name }}"

      - name: Write files
        id: write
        shell: bash
        run: |
          set -euo pipefail
          echo '${{ inputs.files_json }}' | jq -r 'keys[]' | while read -r path; do
            mkdir -p "$(dirname "$path")"
            b64=$(echo '${{ inputs.files_json }}' | jq -r --arg p "$path" '.[$p]')
            echo "$b64" | base64 -d > "$path"
            echo "Wrote $path"
          done

      - name: Commit changes
        run: |
          git add -A
          git commit -m "${{ inputs.commit_message }}"
          git push --set-upstream origin "${{ inputs.branch_name }}"

      - name: Open PR
        if: ${{ inputs.open_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ inputs.branch_name }}
          title: ${{ inputs.commit_message }}
          body: "Automated bulk update via workflow"
          base: ${{ github.event.repository.default_branch }}
          labels: automated
